name = "durable-streams-subscriptions"
main = "src/http/worker.ts"
compatibility_date = "2025-02-02"
compatibility_flags = []

[vars]
SESSION_TTL_SECONDS = "86400"

# Durable Objects for per-stream subscriber storage and per-session subscription tracking
[durable_objects]
bindings = [
  { name = "SUBSCRIPTION_DO", class_name = "SubscriptionDO" },
  { name = "SESSION_DO", class_name = "SessionDO" },
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["SubscriptionDO"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["SessionDO"]

# Analytics Engine for observability metrics
[[analytics_engine_datasets]]
binding = "METRICS"
dataset = "subscriptions_metrics"

# KV namespace for per-project signing secrets
[[kv_namespaces]]
binding = "REGISTRY"
id = "registry"

# Service binding to core worker (required)
[[services]]
binding = "CORE"
service = "durable-streams"

# Queue-based fanout for hot topics.
# Without this binding, fanout is always inline.
[[queues.producers]]
binding = "FANOUT_QUEUE"
queue = "subscription-fanout"

# Uncomment to enable queue consumer (processes async fanout messages):
# [[queues.consumers]]
# queue = "subscription-fanout"
# max_batch_size = 10
# max_batch_timeout = 1
# max_retries = 3
# dead_letter_queue = "subscription-fanout-dlq"
