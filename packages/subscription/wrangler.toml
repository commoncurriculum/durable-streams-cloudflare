name = "durable-streams-subscriptions"
main = "src/http/worker.ts"
compatibility_date = "2025-02-02"

[vars]
SESSION_TTL_SECONDS = "1800"
# Required for Analytics Engine SQL queries (cleanup)
# ACCOUNT_ID = "<your-cloudflare-account-id>"
# API_TOKEN should be set via: npx wrangler secret put API_TOKEN
ANALYTICS_DATASET = "subscriptions_metrics"

# Durable Objects for per-stream subscriber storage
[durable_objects]
bindings = [
  { name = "SUBSCRIPTION_DO", class_name = "SubscriptionDO" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["SubscriptionDO"]

# Analytics Engine for observability metrics
[[analytics_engine_datasets]]
binding = "METRICS"
dataset = "subscriptions_metrics"

# KV namespace for per-project signing secrets
[[kv_namespaces]]
binding = "PROJECT_KEYS"
id = "<your-kv-namespace-id>"

# Service binding to core worker (required)
[[services]]
binding = "CORE"
service = "durable-streams"

# Queue-based fanout for hot topics (uncomment to enable)
# Without this, fanout is always inline â€” safe for local dev.
# [[queues.producers]]
# binding = "FANOUT_QUEUE"
# queue = "subscription-fanout"
#
# [[queues.consumers]]
# queue = "subscription-fanout"
# max_batch_size = 10
# max_batch_timeout = 1
# max_retries = 3
# dead_letter_queue = "subscription-fanout-dlq"

# Session cleanup cron
[triggers]
crons = ["*/5 * * * *"]
